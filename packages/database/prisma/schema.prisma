generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(uuid())
  email                  String            @unique
  password               String
  name                   String?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  role                   Role              @default(CLIENT)
  countryOfBirth         String?
  dateOfBirth            DateTime?
  driverLicenseEncrypted String?
  firstName              String?
  lastName               String?
  middleName             String?
  passportDataEncrypted  String?
  primaryLanguage        String?
  profileCompleted       Boolean           @default(false)
  profileCompletedAt     DateTime?
  ssnEncrypted           String?
  ssnLast4               String?
  taxIdType              String?
  termsAcceptedAt        DateTime?
  termsVersion           String?
  driverLicenseLast4     String?
  passportLast4          String?
  passwordResetExpires   DateTime?
  passwordResetToken     String?
  emailVerificationToken String?
  emailVerified          Boolean           @default(false)
  emailVerifiedAt        DateTime?
  twoFactorBackupCodes   String?
  twoFactorEnabled       Boolean           @default(false)
  twoFactorSecret        String?
  pinHash                String?
  pinEnabled             Boolean           @default(false)
  fcmToken               String?           @unique
  phone                  String?
  smsConsent             Boolean           @default(false)
  smsConsentDate         DateTime?
  smsConsentVersion      String?
  smsOptOutDate          DateTime?
  clientAppointments     Appointment[]     @relation("ClientAppointments")
  preparedAppointments   Appointment[]     @relation("PreparerAppointments")
  auditLogs              AuditLog[]
  clientConversations    Conversation[]    @relation("ClientConversations")
  preparerConversations  Conversation[]    @relation("PreparerConversations")
  documents              Document[]
  immigrationCases       ImmigrationCase[]
  invoices               Invoice[]
  sentMessages           Message[]
  orders                 Order[]
  clientTaxReturns       TaxReturn[]       @relation("ClientReturns")
  preparedTaxReturns     TaxReturn[]       @relation("PreparerReturns")
}

model TaxReturn {
  id         String      @id @default(uuid())
  year       Int
  status     TaxStatus   @default(DRAFT)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  clientId   String
  preparerId String?
  deductions Deduction[]
  documents  Document[]
  forms      TaxForm[]
  client     User        @relation("ClientReturns", fields: [clientId], references: [id])
  preparer   User?       @relation("PreparerReturns", fields: [preparerId], references: [id])
}

model TaxForm {
  id          String    @id @default(uuid())
  type        String
  data        Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  taxReturnId String
  taxReturn   TaxReturn @relation(fields: [taxReturnId], references: [id])
}

model Deduction {
  id          String    @id @default(uuid())
  category    String
  amount      Decimal
  description String?
  date        DateTime?
  taxReturnId String
  taxReturn   TaxReturn @relation(fields: [taxReturnId], references: [id])
}

model ImmigrationCase {
  id                 String         @id @default(uuid())
  type               CaseType
  uscisReceiptNumber String?
  priorityDate       DateTime?
  status             String         @default("OPEN")
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  userId             String
  timeline           CaseTimeline[]
  documents          Document[]
  user               User           @relation(fields: [userId], references: [id])
}

model CaseTimeline {
  id                String          @id @default(uuid())
  title             String
  description       String?
  date              DateTime        @default(now())
  status            String
  immigrationCaseId String
  immigrationCase   ImmigrationCase @relation(fields: [immigrationCaseId], references: [id])
}

model Document {
  id                String           @id @default(uuid())
  title             String
  type              DocType          @default(OTHER)
  s3Key             String
  url               String?
  mimeType          String?
  size              Int?
  uploadedAt        DateTime         @default(now())
  userId            String
  taxReturnId       String?
  immigrationCaseId String?
  orderId           String?
  immigrationCase   ImmigrationCase? @relation(fields: [immigrationCaseId], references: [id])
  order             Order?           @relation(fields: [orderId], references: [id])
  taxReturn         TaxReturn?       @relation(fields: [taxReturnId], references: [id])
  user              User             @relation(fields: [userId], references: [id])
  conversationId    String?
  conversation      Conversation?    @relation(fields: [conversationId], references: [id])
  messages          Message[]
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model Conversation {
  id         String               @id @default(uuid())
  subject    String
  category   ConversationCategory @default(GENERAL)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  clientId   String
  preparerId String?
  client     User                 @relation("ClientConversations", fields: [clientId], references: [id])
  preparer   User?                @relation("PreparerConversations", fields: [preparerId], references: [id])
  messages   Message[]
  documents  Document[]

  @@index([clientId, updatedAt(sort: Desc)])
  @@index([preparerId, updatedAt(sort: Desc)])
  @@index([updatedAt])
}

model Message {
  id             String       @id @default(uuid())
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversationId String
  senderId       String
  isDelivered    Boolean      @default(false)
  documentId     String?
  document       Document?    @relation(fields: [documentId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt(sort: Asc)])
}

model Invoice {
  id          String        @id @default(uuid())
  status      InvoiceStatus @default(DRAFT)
  amount      Decimal
  currency    String        @default("USD")
  dueDate     DateTime?
  paidAt      DateTime?
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  clientId    String
  client      User          @relation(fields: [clientId], references: [id])
  payments    Payment[]
}

model Payment {
  id        String   @id @default(uuid())
  amount    Decimal
  method    String
  reference String?
  status    String
  createdAt DateTime @default(now())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
}

model Appointment {
  id          String            @id @default(uuid())
  title       String
  date        DateTime
  duration    Int
  status      AppointmentStatus @default(SCHEDULED)
  meetingLink String?
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  clientId    String
  preparerId  String?
  client      User              @relation("ClientAppointments", fields: [clientId], references: [id])
  preparer    User?             @relation("PreparerAppointments", fields: [preparerId], references: [id])
}

model Service {
  id              String           @id @default(uuid())
  name            String
  description     String
  price           Decimal
  category        String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  originalPrice   Decimal?
  descriptionI18n Json?
  nameI18n        Json?
  orders          Order[]
  docTypes        ServiceDoctype[]
  reviews         ServiceReview[]
  steps           ServiceStep[]
}

model ServiceStep {
  id          String  @id @default(uuid())
  orderIndex  Int
  title       String
  description String?
  formConfig  Json?
  serviceId   String
  formId      String?
  form        Form?   @relation(fields: [formId], references: [id])
  service     Service @relation(fields: [serviceId], references: [id])
}

model Form {
  id              String        @id @default(uuid())
  name            String
  description     String?
  version         String        @default("1.0")
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  descriptionI18n Json?
  nameI18n        Json?
  fields          FormField[]
  sections        FormSection[]
  serviceSteps    ServiceStep[]
}

model FormSection {
  id        String      @id @default(uuid())
  formId    String
  title     String
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  titleI18n Json?
  fields    FormField[]
  form      Form        @relation(fields: [formId], references: [id], onDelete: Cascade)
}

model FormField {
  id              String       @id @default(uuid())
  formId          String
  sectionId       String?
  type            String
  name            String
  label           String
  placeholder     String?
  helpText        String?
  required        Boolean      @default(false)
  order           Int          @default(0)
  rules           Json?
  options         Json?
  accept          String?
  maxFiles        Int?
  maxSize         Int?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  helpTextI18n    Json?
  labelI18n       Json?
  placeholderI18n Json?
  form            Form         @relation(fields: [formId], references: [id], onDelete: Cascade)
  section         FormSection? @relation(fields: [sectionId], references: [id], onDelete: Cascade)
}

model ServiceDoctype {
  id         String  @id @default(uuid())
  docType    DocType
  isRequired Boolean @default(true)
  serviceId  String
  service    Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

model Order {
  id        String              @id @default(uuid())
  displayId String?             @unique
  status    String              @default("IN_PROGRESS")
  total     Decimal             @default(0)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  userId    String
  serviceId String
  notes     String?
  documents Document[]
  service   Service             @relation(fields: [serviceId], references: [id])
  user      User                @relation(fields: [userId], references: [id])
  approvals OrderApproval[]
  progress  OrderStepProgress[]
  timeline  OrderTimeline[]
}

model OrderTimeline {
  id          String   @id @default(uuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
}

model OrderApproval {
  id          String   @id @default(uuid())
  type        String
  title       String
  description String?
  status      String   @default("PENDING")
  clientNote  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
}

model OrderStepProgress {
  id          String   @id @default(uuid())
  stepIndex   Int
  data        Json?
  completedAt DateTime @default(now())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
}

model ServiceReview {
  id        String   @id @default(uuid())
  author    String
  rating    Int
  text      String
  date      DateTime @default(now())
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id])
}

model CompanyProfile {
  id             String   @id @default(uuid())
  companyName    String
  dba            String?
  description    String?
  email          String
  phone          String
  address        String
  website        String?
  businessHours  Json?
  socialLinks    Json?
  primaryColor   String?  @default("#0F172A")
  secondaryColor String?  @default("#2563EB")
  updatedAt      DateTime @updatedAt
  faviconUrl     String?
  logoUrl        String?
  themeOptions   Json?
}

model FAQ {
  id           String   @id @default(uuid())
  question     String
  answer       String
  questionI18n Json?
  answerI18n   Json?
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum ConversationCategory {
  GENERAL
  TECHNICAL
  BILLING
  URGENT
}

enum Role {
  ADMIN
  CLIENT
  PREPARER
}

enum TaxStatus {
  DRAFT
  IN_REVIEW
  FILED
  ACCEPTED
  REJECTED
  COMPLETED
}

enum CaseType {
  RESIDENCY
  CITIZENSHIP
  VISA_WORK
  VISA_FAMILY
  OTHER
}

enum DocType {
  PASSPORT
  ID_CARD
  DRIVER_LICENSE
  TAX_FORM
  PROOF_OF_INCOME
  SSN_CARD
  W2_FORM
  PAYSTUB
  TAX_RETURN
  LEGAL_DOCUMENT
  MEDICAL_RECORD
  RECEIPT
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}
